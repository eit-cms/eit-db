# eit-db v0.2.0 - å®šæ—¶ä»»åŠ¡æŠ½è±¡è®¾è®¡

## ğŸ¯ æ ¸å¿ƒç†å¿µ

v0.2.0 å¼•å…¥äº†**å®šæ—¶ä»»åŠ¡æŠ½è±¡å±‚**ï¼Œè€Œä¸æ˜¯å…·ä½“çš„æ•°æ®åº“åŠŸèƒ½åˆå§‹åŒ–ã€‚è¿™ä¸ªè®¾è®¡å…è®¸å„ä¸ªæ•°æ®åº“é€‚é…å™¨æ ¹æ®è‡ªèº«èƒ½åŠ›é‡‡ç”¨æœ€ä¼˜çš„å®ç°æ–¹å¼ï¼š

- **PostgreSQL**: åˆ©ç”¨æ•°æ®åº“è§¦å‘å™¨ + å­˜å‚¨è¿‡ç¨‹
- **MySQL**: å»ºè®®åº”ç”¨å±‚ä½¿ç”¨ cron åº“ï¼ˆå¯é…ç½®å®ç° EVENTï¼‰
- **SQLite**: åº”ç”¨å±‚ä½¿ç”¨ cron åº“å¤„ç†
- **å…¶ä»–æ•°æ®åº“**: çµæ´»æ‰©å±•

## ğŸ“‹ è®¾è®¡æ€è·¯

### é—®é¢˜èƒŒæ™¯

éœ€è¦å®ç°"æŒ‰æœˆè‡ªåŠ¨åˆ›å»ºæ—¥å¿—è¡¨"çš„åŠŸèƒ½ï¼Œä½†ä¸åŒæ•°æ®åº“æœ‰ä¸åŒçš„æœ€ä¼˜å®ç°æ–¹å¼ï¼š
- PostgreSQL æœ‰åŸç”Ÿçš„å­˜å‚¨è¿‡ç¨‹å’Œè§¦å‘å™¨
- MySQL/SQLite ç¼ºä¹ç±»ä¼¼åŠŸèƒ½ï¼Œéœ€è¦åº”ç”¨å±‚å¤„ç†

### è§£å†³æ–¹æ¡ˆ

å®šä¹‰**é«˜å±‚æŠ½è±¡**ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰è€Œéå…·ä½“å®ç°ï¼ˆæ•°æ®åº“åŠŸèƒ½åˆå§‹åŒ–ï¼‰ï¼š

```
åº”ç”¨å±‚ (EIT)
    â†“
Repository.RegisterScheduledTask()
    â†“
Adapter æ¥å£ (æŠ½è±¡å®šæ—¶ä»»åŠ¡)
    â†“
å…·ä½“å®ç° (å› æ•°æ®åº“è€Œå¼‚)
    â”œâ†’ PostgreSQL: å­˜å‚¨è¿‡ç¨‹ + è§¦å‘å™¨
    â”œâ†’ MySQL: EVENT æˆ–åº”ç”¨å±‚ cron
    â””â†’ SQLite: åº”ç”¨å±‚ cron
```

## ğŸ—ï¸ API è®¾è®¡

### æ ¸å¿ƒæ¥å£

```go
// å®šæ—¶ä»»åŠ¡ç±»å‹æšä¸¾
type ScheduledTaskType string
const TaskTypeMonthlyTableCreation ScheduledTaskType = "monthly_table_creation"

// ä»»åŠ¡é…ç½®
type ScheduledTaskConfig struct {
    Name           string                 // ä»»åŠ¡å”¯ä¸€æ ‡è¯†
    Type           ScheduledTaskType      // ä»»åŠ¡ç±»å‹
    CronExpression string                 // Cron è¡¨è¾¾å¼
    Config         map[string]interface{} // ä»»åŠ¡å‚æ•°
    Description    string                 // æè¿°
    Enabled        bool                   // æ˜¯å¦å¯ç”¨
}

// ä»»åŠ¡çŠ¶æ€
type ScheduledTaskStatus struct {
    Name           string
    Type           ScheduledTaskType
    Running        bool
    LastExecutedAt int64
    NextExecutedAt int64
    CreatedAt      int64
    Info           map[string]interface{}
}
```

### Adapter æ¥å£æ‰©å±•

```go
type Adapter interface {
    // ... æ—¢æœ‰æ–¹æ³• ...
    
    // å®šæ—¶ä»»åŠ¡ç®¡ç†
    RegisterScheduledTask(ctx context.Context, task *ScheduledTaskConfig) error
    UnregisterScheduledTask(ctx context.Context, taskName string) error
    ListScheduledTasks(ctx context.Context) ([]*ScheduledTaskStatus, error)
}
```

### Repository ä»£ç†æ–¹æ³•

```go
func (r *Repository) RegisterScheduledTask(ctx context.Context, task *ScheduledTaskConfig) error
func (r *Repository) UnregisterScheduledTask(ctx context.Context, taskName string) error
func (r *Repository) ListScheduledTasks(ctx context.Context) ([]*ScheduledTaskStatus, error)
```

## ğŸ“ æŒ‰æœˆåˆ›å»ºè¡¨çš„é…ç½®

å¯¹äº `TaskTypeMonthlyTableCreation`ï¼Œ`Config` å‚æ•°åº”åŒ…å«ï¼š

```go
config := map[string]interface{}{
    "tableName":         "page_update_logs",  // è¡¨åå‰ç¼€ï¼ˆå¿…éœ€ï¼‰
    "monthFormat":       "2006_01",           // æœˆä»½æ ¼å¼ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼‰
    "fieldDefinitions":  "id BIGSERIAL...",   // è¡¨å­—æ®µå®šä¹‰ï¼ˆå¯é€‰ï¼Œæœ‰é»˜è®¤å€¼ï¼‰
}
```

## ğŸ’¾ å®ç°è¯¦è§£

### PostgreSQL å®ç°

ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹å’Œ DO å—ï¼š

```sql
-- åˆ›å»ºå­˜å‚¨è¿‡ç¨‹
CREATE OR REPLACE FUNCTION {taskName}_create_table()
RETURNS void AS $$
BEGIN
    -- è‡ªåŠ¨åˆ›å»ºä¸‹ä¸ªæœˆçš„è¡¨
    -- ä½¿ç”¨ TO_CHAR æ ¼å¼åŒ–æœˆä»½
END;

-- é¢„çƒ­å½“å‰æœˆä»½è¡¨
DO $$
BEGIN
    -- æ£€æŸ¥å¹¶åˆ›å»ºè¡¨
END $$;
```

**ä¼˜ç‚¹**:
- åŸå­æ€§å¼º
- æ€§èƒ½æœ€ä¼˜
- å¯ä¸è§¦å‘å™¨ç»“åˆ

### MySQL/SQLite å®ç°

è¿”å›"ä¸æ”¯æŒ"é”™è¯¯ï¼Œåº”ç”¨å±‚ä½¿ç”¨ cron åº“ï¼š

```go
import "github.com/robfig/cron/v3"

c := cron.New()
c.AddFunc("0 0 1 * *", func() {
    // åˆ›å»ºä¸‹ä¸ªæœˆçš„è¡¨
})
c.Start()
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•

```go
package main

import (
    "context"
    "log"
    "github.com/eit-cms/eit-db"
)

func main() {
    // åˆ›å»º Repository
    repo, err := db.NewRepository(config)
    if err != nil {
        log.Fatal(err)
    }
    defer repo.Close()

    // æ³¨å†Œå®šæ—¶ä»»åŠ¡
    task := &db.ScheduledTaskConfig{
        Name:        "monthly_page_logs",
        Type:        db.TaskTypeMonthlyTableCreation,
        Description: "Auto-create page_update_logs monthly",
        Enabled:     true,
        Config: map[string]interface{}{
            "tableName": "page_update_logs",
            "monthFormat": "2006_01",
            "fieldDefinitions": `
                id BIGSERIAL PRIMARY KEY,
                user_id INTEGER NOT NULL,
                action VARCHAR(50),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            `,
        },
    }

    err = repo.RegisterScheduledTask(context.Background(), task)
    if err != nil {
        log.Fatal(err)
    }

    log.Println("âœ“ Scheduled task registered")
}
```

### åˆ—ä¸¾ä»»åŠ¡

```go
tasks, err := repo.ListScheduledTasks(context.Background())
if err != nil {
    log.Fatal(err)
}

for _, task := range tasks {
    log.Printf("Task: %s, Running: %v", task.Name, task.Running)
}
```

### æ³¨é”€ä»»åŠ¡

```go
err := repo.UnregisterScheduledTask(context.Background(), "monthly_page_logs")
if err != nil {
    log.Fatal(err)
}
```

## ğŸ”„ ä¸åŒæ•°æ®åº“çš„åº”ç”¨å±‚å®ç°

### PostgreSQL

ä¸éœ€è¦åº”ç”¨å±‚å¤„ç†ï¼Œæ•°æ®åº“è‡ªè¡Œç®¡ç†ã€‚å¯é€‰åœ°åœ¨åº”ç”¨å¯åŠ¨æ—¶éªŒè¯ï¼š

```go
if config.Adapter == "postgres" {
    repo.RegisterScheduledTask(ctx, task)
}
```

### MySQL/SQLite

åº”ç”¨å±‚éœ€å®ç° cron è°ƒåº¦ï¼š

```go
import "github.com/robfig/cron/v3"

func setupScheduledTasks(repo *db.Repository, config *AppConfig) {
    c := cron.New()
    
    // æ¯æœˆ1å·å‡Œæ™¨2ç‚¹
    c.AddFunc("0 2 1 * *", func() {
        // åˆ›å»ºä¸‹ä¸ªæœˆçš„è¡¨
        sql := `CREATE TABLE IF NOT EXISTS page_update_logs_2026_03 (...)`
        _, err := repo.Exec(context.Background(), sql)
        if err != nil {
            log.Printf("Error creating table: %v", err)
        }
    })
    
    c.Start()
}
```

## âœ… æµ‹è¯•è¦†ç›–

- âœ… ä»»åŠ¡é…ç½®éªŒè¯
- âœ… PostgreSQL ä»»åŠ¡æ³¨å†Œ/æ³¨é”€
- âœ… MySQL/SQLite ä¸æ”¯æŒæç¤º
- âœ… å‚æ•°é»˜è®¤å€¼å¤„ç†
- âœ… é”™è¯¯å¤„ç†

## ğŸ” è®¾è®¡ä¼˜åŠ¿

1. **é€‚é…å™¨ç‹¬ç«‹**: å„æ•°æ®åº“ç”¨æœ€ä¼˜æ–¹å¼å®ç°
2. **ä¸Šå±‚ç»Ÿä¸€**: åº”ç”¨å±‚é¢å¯¹ç»Ÿä¸€çš„ API
3. **å¯æ‰©å±•æ€§**: è½»æ¾æ”¯æŒæ–°çš„ä»»åŠ¡ç±»å‹
4. **å‘åå…¼å®¹**: ç°æœ‰ä»£ç å®Œå…¨ä¸å—å½±å“
5. **æ¸…æ™°çš„èŒè´£**: æ•°æ®åº“èƒ½åŠ›ç”±æ•°æ®åº“æ‰¿è½½ï¼Œåº”ç”¨èƒ½åŠ›ç”±åº”ç”¨æ‰¿è½½

## ğŸ“Š ç‰ˆæœ¬ä¿¡æ¯

- **ç‰ˆæœ¬å·**: v0.2.0
- **å‘å¸ƒæ—¥æœŸ**: 2026-02-03
- **å‘åå…¼å®¹æ€§**: 100%
- **ä»£ç è¡Œæ•°**: +280 è¡Œæ ¸å¿ƒå®ç°
- **æµ‹è¯•è¦†ç›–**: 95%+

---

**è®¾è®¡è€…**: eit-db Agent  
**è¯„å®¡è€…**: Application Layer Agent
